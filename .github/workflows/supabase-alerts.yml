name: Send MedWatch alerts

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  send-alerts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Run scheduled alerts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SERVICE_ROLE_KEY: ${{ secrets.SERVICE_ROLE_KEY }}
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_WHATSAPP_FROM: ${{ secrets.TWILIO_WHATSAPP_FROM }}
          TWILIO_TEMPLATE_ALERT_DOSE_SID: ${{ secrets.TWILIO_TEMPLATE_ALERT_DOSE_SID }}
          TWILIO_TEMPLATE_LOW_STOCK_SID: ${{ secrets.TWILIO_TEMPLATE_LOW_STOCK_SID }}
        run: |
          if [ -z "$SUPABASE_URL" ] || [ -z "$SERVICE_ROLE_KEY" ]; then
            echo "Missing SUPABASE_URL or SERVICE_ROLE_KEY secrets."
            exit 1
          fi
          if [ -z "$TWILIO_ACCOUNT_SID" ] || [ -z "$TWILIO_AUTH_TOKEN" ] || [ -z "$TWILIO_WHATSAPP_FROM" ]; then
            echo "Missing Twilio secrets."
            exit 1
          fi
          if [ -z "$TWILIO_TEMPLATE_ALERT_DOSE_SID" ] || [ -z "$TWILIO_TEMPLATE_LOW_STOCK_SID" ]; then
            echo "Missing Twilio template SID secrets."
            exit 1
          fi
          node "scripts/send-alerts.mjs" | tee /tmp/alerts.json
      - name: Report sent count
        run: |
          if [ -s /tmp/alerts.json ]; then
            node -e 'const fs=require("fs");const lines=fs.readFileSync("/tmp/alerts.json","utf8").trim().split(/\r?\n/);const last=lines[lines.length-1]||"{}";const data=JSON.parse(last);const count=data.sentCount ?? 0;console.log("Messages sent: "+count);fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, `Messages sent: ${count}\n`);'
          else
            echo "Messages sent: 0"
            echo "Messages sent: 0" >> "$GITHUB_STEP_SUMMARY"
          fi
